<!DOCTYPE html>
<html>
<head>
    <title>CORS Debug for Zebra Associates</title>
    <meta charset="utf-8">
</head>
<body>
    <h1>MarketEdge CORS Debug Test</h1>
    <div id="results"></div>
    <button onclick="testCorsAuth()">Test Authentication CORS</button>
    <button onclick="testCorsOptions()">Test OPTIONS Request</button>
    <button onclick="testCorsHealth()">Test Health Endpoint</button>
    
    <script>
        const log = (message) => {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.innerHTML = `<strong>${new Date().toISOString()}</strong>: ${message}`;
            div.style.marginBottom = '10px';
            results.appendChild(div);
            console.log(message);
        };

        async function testCorsOptions() {
            log('Testing OPTIONS preflight request...');
            try {
                const response = await fetch('https://marketedge-platform.onrender.com/api/v1/auth/login', {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': 'https://app.zebra.associates',
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type,Authorization'
                    }
                });
                log(`OPTIONS Response Status: ${response.status}`);
                log(`OPTIONS Response Headers: ${JSON.stringify(Object.fromEntries(response.headers))}`);
            } catch (error) {
                log(`OPTIONS Error: ${error.message}`);
            }
        }

        async function testCorsAuth() {
            log('Testing actual authentication request...');
            try {
                const response = await fetch('https://marketedge-platform.onrender.com/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': 'https://app.zebra.associates'
                    },
                    body: JSON.stringify({
                        code: 'test_code',
                        redirect_uri: 'https://app.zebra.associates/callback'
                    })
                });
                
                log(`Auth Response Status: ${response.status}`);
                log(`Auth Response Headers: ${JSON.stringify(Object.fromEntries(response.headers))}`);
                
                const responseText = await response.text();
                log(`Auth Response Body: ${responseText}`);
                
            } catch (error) {
                log(`Auth Error: ${error.message}`);
                log(`Auth Error Stack: ${error.stack}`);
            }
        }

        async function testCorsHealth() {
            log('Testing health endpoint...');
            try {
                const response = await fetch('https://marketedge-platform.onrender.com/health', {
                    headers: {
                        'Origin': 'https://app.zebra.associates'
                    }
                });
                log(`Health Response Status: ${response.status}`);
                log(`Health Response Headers: ${JSON.stringify(Object.fromEntries(response.headers))}`);
                
                const data = await response.json();
                log(`Health Response: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                log(`Health Error: ${error.message}`);
            }
        }

        // Run tests automatically when page loads
        window.onload = () => {
            log('Page loaded - running automatic tests...');
            setTimeout(() => testCorsHealth(), 1000);
            setTimeout(() => testCorsOptions(), 2000);
            setTimeout(() => testCorsAuth(), 3000);
        };
    </script>
</body>
</html>