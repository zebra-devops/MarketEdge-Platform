# Environment Variables Checklist - Staging Deployment

**Branch:** `test/trigger-zebra-smoke`
**Date:** 2025-10-02
**Purpose:** Authentication Fixes Deployment

## üîê Critical Environment Variables

### Auth0 Configuration (REQUIRED)

| Variable | Value | Required | Notes |
|----------|-------|----------|-------|
| `AUTH0_DOMAIN` | `dev-g8trhgbfdq2sk2m8.us.auth0.com` | ‚úÖ Yes | Production Auth0 tenant |
| `AUTH0_CLIENT_ID` | `wEgjaOnk8MSgRTdaWURNKaFu80MG0Sa6` | ‚úÖ Yes | Auth0 application client ID |
| `AUTH0_CLIENT_SECRET` | `<from secrets vault>` | ‚úÖ Yes | **NEVER commit to git** |
| `AUTH0_ACTION_SECRET` | `<from secrets vault>` | ‚úÖ Yes | Used by Auth0 Actions to call backend |
| **`AUTH0_AUDIENCE`** | `https://dev-g8trhgbfdq2sk2m8.us.auth0.com/api/v2/` | ‚úÖ **YES** | **NEW - CRITICAL FIX** |

### Auth0 Staging Configuration (Optional - if using separate staging tenant)

| Variable | Value | Required | Notes |
|----------|-------|----------|-------|
| `AUTH0_DOMAIN_STAGING` | `dev-g8trhgbfdq2sk2m8.us.auth0.com` | ‚ö†Ô∏è Optional | Use if staging has separate tenant |
| `AUTH0_CLIENT_ID_STAGING` | `<staging client id>` | ‚ö†Ô∏è Optional | Staging-specific client ID |
| `AUTH0_CLIENT_SECRET_STAGING` | `<from secrets vault>` | ‚ö†Ô∏è Optional | **NEVER commit to git** |
| `AUTH0_AUDIENCE_STAGING` | `https://dev-g8trhgbfdq2sk2m8.us.auth0.com/api/v2/` | ‚ö†Ô∏è Optional | Staging API audience |

### Application Configuration

| Variable | Value | Required | Notes |
|----------|-------|----------|-------|
| `JWT_SECRET_KEY` | `<from secrets vault>` | ‚úÖ Yes | **NEVER commit to git** |
| `DATABASE_URL` | `postgresql://...` | ‚úÖ Yes | PostgreSQL connection string |
| `REDIS_URL` | `redis://...` | ‚ö†Ô∏è Optional | Required for rate limiting |
| `SECRET_KEY` | `<auto-generated by Render>` | ‚úÖ Yes | FastAPI secret key |

### Environment Control

| Variable | Value | Required | Notes |
|----------|-------|----------|-------|
| `ENVIRONMENT` | `staging` | ‚úÖ Yes | Set to `staging` for preview environments |
| `USE_STAGING_AUTH0` | `true` | ‚úÖ Yes | Use staging Auth0 config (preview envs) |
| `ENABLE_DEBUG_LOGGING` | `true` | ‚ö†Ô∏è Optional | Enable verbose logging for staging |
| `RUN_MIGRATIONS` | `true` | ‚ö†Ô∏è Optional | Auto-handled in render-startup.sh |

### CORS Configuration

| Variable | Value | Required | Notes |
|----------|-------|----------|-------|
| `CORS_ORIGINS` | `https://app.zebra.associates,https://*.onrender.com,http://localhost:3000` | ‚úÖ Yes | Comma-separated list of allowed origins |

### Monitoring (Optional)

| Variable | Value | Required | Notes |
|----------|-------|----------|-------|
| `SENTRY_DSN` | `<Sentry project DSN>` | ‚ùå No | Error tracking for production |
| `LOG_LEVEL` | `DEBUG` | ‚ùå No | Set to `INFO` for production |

## ‚úÖ Pre-Deployment Verification Script

Run this script to verify all required variables are set:

```bash
#!/bin/bash

echo "üîç Checking required environment variables for staging deployment..."

# Required variables
REQUIRED_VARS=(
  "AUTH0_DOMAIN"
  "AUTH0_CLIENT_ID"
  "AUTH0_CLIENT_SECRET"
  "AUTH0_ACTION_SECRET"
  "AUTH0_AUDIENCE"
  "JWT_SECRET_KEY"
  "DATABASE_URL"
  "ENVIRONMENT"
  "USE_STAGING_AUTH0"
  "CORS_ORIGINS"
)

MISSING_VARS=()

for var in "${REQUIRED_VARS[@]}"; do
  if [ -z "${!var}" ]; then
    MISSING_VARS+=("$var")
    echo "‚ùå Missing: $var"
  else
    echo "‚úÖ Set: $var"
  fi
done

if [ ${#MISSING_VARS[@]} -gt 0 ]; then
  echo ""
  echo "‚ùå DEPLOYMENT BLOCKED: Missing ${#MISSING_VARS[@]} required variable(s)"
  echo "üìã Missing variables: ${MISSING_VARS[*]}"
  exit 1
else
  echo ""
  echo "‚úÖ All required environment variables are set"
  echo "üöÄ Ready for deployment"
  exit 0
fi
```

## üîë AUTH0_AUDIENCE - Critical Fix Explanation

### Why This Variable is Critical

**Without `AUTH0_AUDIENCE`:**
- Auth0 returns **opaque tokens** (random strings)
- Opaque tokens **cannot be verified cryptographically**
- Application must call Auth0 `/userinfo` endpoint for every request (slow, rate-limited)
- Tokens cannot be validated offline

**With `AUTH0_AUDIENCE`:**
- Auth0 returns **JWT tokens** (JSON Web Tokens)
- JWT tokens can be verified using **JWKS (JSON Web Key Set)**
- Cryptographic signature verification (fast, secure)
- Tokens can be validated offline without calling Auth0
- Significantly better performance and security

### How to Set in Render

**Via Dashboard:**
1. Navigate to: https://dashboard.render.com
2. Select service: `marketedge-platform`
3. Go to: **Environment** tab
4. Click: **Add Environment Variable**
5. Key: `AUTH0_AUDIENCE`
6. Value: `https://dev-g8trhgbfdq2sk2m8.us.auth0.com/api/v2/`
7. Click: **Save Changes**
8. Redeploy service

**Via render.yaml (already configured):**
```yaml
envVars:
  - key: AUTH0_AUDIENCE
    sync: false  # Set manually in Render dashboard
```

### Verification

After setting, check logs for:
```
‚úÖ API audience added to auth request for JWT tokens
   audience: https://dev-g8trhgbfdq2sk2m8.us.auth0.com/api/v2/
```

If not set, you'll see:
```
‚ö†Ô∏è  No AUTH0_AUDIENCE configured - Auth0 will return opaque tokens
   note: Opaque tokens cannot be verified cryptographically
```

## üö® Security Best Practices

### Never Commit These to Git:
- ‚ùå `AUTH0_CLIENT_SECRET`
- ‚ùå `AUTH0_CLIENT_SECRET_STAGING`
- ‚ùå `AUTH0_ACTION_SECRET`
- ‚ùå `JWT_SECRET_KEY`
- ‚ùå `DATABASE_URL` (contains password)
- ‚ùå `REDIS_URL` (contains password)

### Secret Management:
- ‚úÖ Store secrets in 1Password or similar vault
- ‚úÖ Use Render's environment variable encryption
- ‚úÖ Rotate secrets regularly (every 90 days)
- ‚úÖ Use different secrets for staging vs production
- ‚úÖ Limit access to secrets (need-to-know basis)

### Environment Separation:
- ‚úÖ Staging uses `USE_STAGING_AUTH0=true`
- ‚úÖ Production uses `USE_STAGING_AUTH0=false` or unset
- ‚úÖ Different database instances for staging vs production
- ‚úÖ Separate Auth0 tenants (or applications) for environments

## üìã Quick Copy-Paste for Render Dashboard

**For Staging/Preview Environments:**

```
# Auth0 Configuration
AUTH0_DOMAIN=dev-g8trhgbfdq2sk2m8.us.auth0.com
AUTH0_CLIENT_ID=wEgjaOnk8MSgRTdaWURNKaFu80MG0Sa6
AUTH0_CLIENT_SECRET=<GET_FROM_1PASSWORD>
AUTH0_ACTION_SECRET=<GET_FROM_1PASSWORD>
AUTH0_AUDIENCE=https://dev-g8trhgbfdq2sk2m8.us.auth0.com/api/v2/

# Environment Control
ENVIRONMENT=staging
USE_STAGING_AUTH0=true
ENABLE_DEBUG_LOGGING=true

# Application
JWT_SECRET_KEY=<GET_FROM_1PASSWORD>
DATABASE_URL=<GET_FROM_RENDER_POSTGRES>
REDIS_URL=<GET_FROM_RENDER_REDIS>

# CORS
CORS_ORIGINS=https://app.zebra.associates,https://*.onrender.com,http://localhost:3000
```

## üîó Related Resources

- [Render Environment Variables Documentation](https://render.com/docs/environment-variables)
- [Auth0 API Audience Documentation](https://auth0.com/docs/get-started/apis/api-settings#api-audience)
- [JWT vs Opaque Tokens](https://auth0.com/docs/secure/tokens/access-tokens)
- [JWKS Verification](https://auth0.com/docs/secure/tokens/json-web-tokens/json-web-key-sets)

---

**Document Version:** 1.0
**Last Updated:** 2025-10-02
**Author:** Maya (DevOps Agent)
